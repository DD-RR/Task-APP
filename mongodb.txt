//Operaciones CRUD (ABC) para la aplicación de Administrador de Tareas 
//importamos el modulo de mongoDB
/* const mongodb = require('mongodb')
const MongoClient = mongodb.MongoClient 
//  Creamos nuestros popios ID's
const ObjectID = mongodb.ObjectID   */
const { MongoClient, ObjectID } = require('mongodb')

//Definimos la URl para la coneción con la BD de mongo
const connectionURL = 'mongodb://127.0.0.1:27017'
const databaseName = 'task-manager'

// Generamos nuestros porpios ID's
/* const id = new ObjectID()
console.log(id.id.length);
console.log(id.toHexString().length);
// console.log(id.getTimestamp()); */


// Dentro irá el Crud de nuestra base de datos.
//Usamos el MongoClient para conectarnos al servidor /* .id */
MongoClient.connect(connectionURL, { useNewUrlParser: true}, (err, cliente) => {
    if (err) {
        return console.log('No se puede conectar a la Base de Datos!!!');
    } 
    //creación de la Bd mediante MongoDB
    const db = cliente.db(databaseName) 

    //En MongoDb tenemos documentos
    /* db.collection('users').insertOne({
        // _id: id, Remover esta linea
        name: 'Diego',
        edad: 28
    }, (err, result) => {
        if (err) {
            return console.log('No se ah podido ingresar usuario (Verifique los Datos)');
        }  

        console.log(result.ops);
    }) */


    // referencia hacia la coleccìon que queremos ingresar a la base de datos
    //En este ejemplo ingresamos más de un documento.
    /* db.collection('users').insertMany([
        {
            name: 'Michael',
            edad: 26
        }, {
            name: 'Norma',
            edad: 47
        }
    ], (err, result) => {
        if (err) {
            console.log('No se Puede Ingresar Usuarios. ');
        }
        console.log(result.ops);
    }) */

    // Colección Administrador
    /* db.collection('task').insertMany([
        {
            descripcion: 'Limpiar la Casa',
            completada: true
        }, {
            descripcion: 'Renovar Inscripción',
            completada: false
        }, {
            descripcion: 'Comprar Comida para el Perro',
            completada: false
        }
    ], (err, result) => {
        if (err) {
            return console.log('No se puede Ingresar Datos');
        }
        console.log(result.ops);
    }) */

    // Buscar solo Uno
  /*   db.collection('users').findOne({ _id: new ObjectID('5e4ade3f761ccc0678239e23')}, (err, user) => { 
        if (err) {
            return console.log('No es posible efectuar la busqueda');
        }
        console.log(user);
    }) */

    // Busqueda de todo lo que conicida con el objeto mandado
/*     db.collection('users').find({ edad: 28 }).toArray((err, users) => {
        console.log(users);
    })
    
    // Consulta usando el metodo Contador
    db.collection('users').find({ edad: 28 }).count((err, count) => {
        console.log(count);
    }) */

    // Buscar Solo a un por su id
    db.collection('task').findOne({ _id: new ObjectID('5e4ae06ef762a30680befdef') }, (err, task) => {
        console.log(task); 
    })

    db.collection('task').find({ completada: false }).toArray((err, task) => {
        console.log(task);
    })

    //Actualizacion de Uno o Varios Registros
    db.collection('users').updateOne({
        _id: new ObjectID('5e4ad8ea66724406613eafc5')
    }, {
        // Operadores de Actualización
        /* $set: { 
            name: 'David'
        } */
        $inc: { //Incremento
            edad: 1
        }
    }).then((result) => {
        console.log(result);
    }).catch((error) => {
        console.log(error);
    })
    db.collection('task').updateMany({
        completada: false
    }, {
        $set: {
            completada: true
        }
    }).then((res) => {
        console.log(res.modifiedCount);
    }).catch((err) => {
        console.log(err);
    })

     //Eliminar uno o Varios Registros de MongoDB
    /* db.collection('users').deleteMany({
        // Aqui se proporcionan los criterios de busqueda para la eliminación
        edad: 28
    }).then((res) => {
        console.log(res);
    }).catch((err) => {
        console.log(err);
    }) */
    //Elimincación de un documento mediante su descripción
    db.collection('task').deleteOne({
        descripcion: 'Renovar Inscripción'
    }).then((resu) => {
        console.log(resu);
    }).catch((err) => {
        console.log(err);
    })


}) 

// documento mongodb.js

//Operaciones CRUD (ABC) para la aplicación de Administrador de Tareas 

const { MongoClient, ObjectID } = require('mongodb')

//Definimos la URl para la coneción con la BD de mongo
const connectionURL = 'mongodb://127.0.0.1:27017'
const databaseName = 'task-manager'

MongoClient.connect(connectionURL, { useNewUrlParser: true }, (err, client) => {
    if (err) {
        return console.log('No se ah podido Conectar con la Base de Datos (Intente Nuevamente)');
    }
    const db = client.db(databaseName)

})


--------------------------------------------------------------------------
Este codigo va dentro de la siguiente ruta src/db/mongoose.js
// Creando Nuevas instancias de los modelos y guardarlas 
/* const me = new User({
    nombre: '    Diego     ',
    correo: 'MIEMAIL@AOL.IO     ',
    password: 'phone989!'
})

me.save().then(() => {
    console.log(me);
}).catch((err) => {
    console.log('Error!', err);
}) */

/* const task = new Task({
    descripcion: 'Aprender Como usar la libreria de Mongoose',
    completada: true
})

task.save().then(() => {
    console.log(task);
}).catch((err) => {
    console.log('Erro!', err);   
}) */


--------------------------------------------------------------------------
//Archivo index.js en este caso se utilizará async y awath para hacer la aplicación mucho más facil de mantener.
// Librerias que se van a usar
const express = require('express')
// No deseamos tomar nada de aqui solo se desa conectar a la base de datos 
require('./db/mongoose')
// Cargamos el Usuario y Tareas
const User = require('./models/user')
const Task = require('./models/task')

// Creando nuevas aplicaciones en express
const app = express()
const port = process.env.PORT || 3000

// Configuración de Post para pasar los json
app.use(express.json())

//Creacion de endpoints (Rutas para los usuarios)
app.post('/users', (req, res) => {
    // Creamos una nueva instancia de Usuario dentro del controlador de ruta
    const user = new User(req.body) //Pasamos un objeto con todos los atributos que deseamos configurar
    //Configuramos la funciñon tipo flecha para el control de exitos y el manejo de errores
    user.save().then(() => {
        res.status(201).send(user)
    }).catch((e) => {
        // Cuando enviamos errores podemos cambiar el Status del codigo, importante enviar el stado del error antes del error
        res.status(400).send(e);
    })
}) 
//Busqueda de todos los Usuarios de la db
app.get('/users', (req, res) => {
    // Esto recupera todos los usuarios almacenados en la bd
     User.find({}).then((user) => {
        res.send(user)
     }).catch((e) => {
        res.status(500).send()
     })
})

//Busqueda por ID de la DB
app.get('/users/:id', (req, res) => {
     //Creamos una variable para obtener el valor del id que se va a buscar
    const _id = req.params.id
    User.findById(_id).then((user) => {
        //Si no hay concidencias con el usuario enviara un error
        if (!user) {
            return res.status(404).send()
        } 
        //Respuesta por si llega a encontrar un usuario dentro de la BD
        res.send(user)
     //Por si la conección llega a fallar   
    }).catch((e) => {
        res.status(500).send()
    })

})


//Creacion de endpoints (Rutas para los tareas)
app.post('/task', (req, res) => {
    const task = new Task(req.body)
    //Podemos cambiar el estado del la respuesta para ser más especifico en el ingreso de datos
    task.save().then(() => {
        res.status(201).send(task)
    }).catch((e) => {
        res.status(400).send(e)
    })
})


//Busqueda de todos las Tareas de la db
app.get('/task', (req, res) => {
    // Esto recupera todos las tareas almacenados en la bd
     Task.find({}).then((task) => {
        res.send(task)
     }).catch((e) => {
        res.status(500).send()
     })
})

//Busqueda por ID de la DB
app.get('/task/:id', (req, res) => {
     //Creamos una variable para obtener el valor del id que se va a buscar
    const _id = req.params.id
    Task.findById(_id).then((task) => {
        //Si no hay concidencias con alguna tarea enviara un error
        if (!task) {
            return res.status(404).send()
        } 
        //Respuesta por si llega a encontrar una tarea dentro de la BD
        res.send(task)
     //Por si la conección llega a fallar   
    }).catch((e) => {
        res.status(500).send()
    })

})



app.listen(port, () => {
    console.log('Servidor levantado en el puert: ' + port);
})

